{% extends 'admin/baseAdmin.html' %}
{% load static %}

{% block content %}
<div class="container-fluid mt-4">
    <h2 class="text-white mb-4">Registrar Venta Manual</h2>
    
    <!-- Mensajes de feedback -->
    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        {% endfor %}
    {% endif %}

    <div class="row">
        <!-- Columna izquierda: Lista de productos con filtros -->
        <div class="col-md-7">
            <div class="card bg-white">
                <div class="card-header bg-dark text-white">
                    <h5 class="mb-0">Seleccionar Producto</h5>
                </div>
                <div class="card-body">
                    <!-- Filtros -->
                    <form method="get" class="mb-3">
                        <div class="row g-2">
                            <div class="col-md-4">
                                <select name="categoria" class="form-select form-select-sm" onchange="this.form.submit()">
                                    <option value="">Todas las categorías</option>
                                    {% for categoria in categorias %}
                                        <option value="{{ categoria.id }}" {% if categoria_seleccionada == categoria.id|stringformat:"s" %}selected{% endif %}>
                                            {{ categoria.nombre_categoria }}
                                        </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-4">
                                <select name="bodega" class="form-select form-select-sm" onchange="this.form.submit()">
                                    <option value="">Todas las bodegas</option>
                                    {% for bodega in bodegas %}
                                        <option value="{{ bodega.id }}" {% if bodega_seleccionada == bodega.id|stringformat:"s" %}selected{% endif %}>
                                            {{ bodega.nombre_bodega }}
                                        </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-4">
                                <input type="text" name="q" class="form-control form-control-sm" placeholder="Buscar producto..." value="{{ busqueda }}">
                            </div>
                        </div>
                    </form>

                    <!-- Tabla de productos -->
                    <div style="max-height: 500px; overflow-y: auto;">
                        <table class="table table-hover table-sm">
                            <thead class="table-light sticky-top">
                                <tr>
                                    <th>Producto</th>
                                    <th>Categoría</th>
                                    <th>Bodega</th>
                                    <th>Stock</th>
                                    <th>Precio</th>
                                    <th>Acción</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for producto in productos %}
                                <tr id="producto-row-{{ producto.id }}" class="producto-row">
                                    <td>{{ producto.nombre_producto }}</td>
                                    <td>{{ producto.categoria.nombre_categoria }}</td>
                                    <td>{{ producto.bodega.nombre_bodega }}</td>
                                    <td>{{ producto.stock }}</td>
                                    <td>${{ producto.costo }}</td>
                                    <td>
                                        <button type="button" class="btn btn-sm btn-primary" 
                                                onclick="seleccionarProducto({{ producto.id }}, '{{ producto.nombre_producto }}', {{ producto.costo }}, {{ producto.stock }})">
                                            Seleccionar
                                        </button>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="6" class="text-center">No hay productos disponibles con los filtros seleccionados.</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Columna derecha: Formulario de venta -->
        <div class="col-md-5">
            <div class="card bg-white">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">Datos de la Venta</h5>
                </div>
                <div class="card-body">
                    <form method="post" id="formVenta">
                        {% csrf_token %}
                        <input type="hidden" name="producto_id" id="producto_id" required>

                        <!-- Producto seleccionado -->
                        <div class="mb-3">
                            <label class="form-label fw-bold">Producto Seleccionado</label>
                            <div id="producto_seleccionado" class="alert alert-info">
                                Ningún producto seleccionado
                            </div>
                        </div>

                        <!-- Nombre del cliente -->
                        <div class="mb-3">
                            <label for="cliente_nombre" class="form-label fw-bold">Nombre del Cliente *</label>
                            <input type="text" class="form-control" id="cliente_nombre" name="cliente_nombre" required placeholder="Ej: Juan Pérez">
                        </div>

                        <!-- Fecha de venta -->
                        <div class="mb-3">
                            <label for="fecha_venta" class="form-label fw-bold">Fecha de Venta *</label>
                            <input type="date" class="form-control" id="fecha_venta" name="fecha_venta" required value="{{ today }}">
                        </div>

                        <!-- Cantidad -->
                        <div class="mb-3">
                            <label for="cantidad" class="form-label fw-bold">Cantidad *</label>
                            <input type="number" class="form-control" id="cantidad" name="cantidad" min="1" required onchange="calcularMonto()">
                            <small class="text-muted">Stock disponible: <span id="stock_info">-</span></small>
                        </div>

                        <!-- Monto automático -->
                        <div class="mb-3">
                            <label class="form-label fw-bold">Monto Total</label>
                            <div class="input-group">
                                <span class="input-group-text">$</span>
                                <input type="number" class="form-control" id="monto_calculado" step="0.01" readonly>
                            </div>
                        </div>

                        <!-- Checkbox para monto personalizado -->
                        <div class="mb-3 form-check">
                            <input type="checkbox" class="form-check-input" id="usar_monto_custom" name="usar_monto_custom" onchange="toggleMontoCustom()">
                            <label class="form-check-label" for="usar_monto_custom">
                                Usar monto personalizado
                            </label>
                        </div>

                        <!-- Monto personalizado (oculto por defecto) -->
                        <div class="mb-3" id="monto_custom_container" style="display: none;">
                            <label for="monto_personalizado" class="form-label fw-bold">Monto Personalizado</label>
                            <div class="input-group">
                                <span class="input-group-text">$</span>
                                <input type="number" class="form-control" id="monto_personalizado" name="monto_personalizado" step="0.01" min="0">
                            </div>
                        </div>

                        <!-- Botones -->
                        <div class="d-flex justify-content-between mt-4">
                            <a href="{% url 'admin:pagos' %}" class="btn btn-secondary">Cancelar</a>
                            <button type="submit" class="btn btn-success" id="btnRegistrar" disabled>Registrar Venta</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let productoData = {
        id: null,
        nombre: null,
        precio: 0,
        stock: 0
    };

    // Establecer fecha actual por defecto
    document.addEventListener('DOMContentLoaded', function() {
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('fecha_venta').value = today;
    });

    function seleccionarProducto(id, nombre, precio, stock) {
        productoData = { id, nombre, precio, stock };
        
        // Actualizar campos ocultos y visibles
        document.getElementById('producto_id').value = id;
        document.getElementById('producto_seleccionado').innerHTML = `
            <strong>${nombre}</strong><br>
            <small>Precio: $${precio} | Stock: ${stock} unidades</small>
        `;
        document.getElementById('stock_info').textContent = stock + ' unidades';
        document.getElementById('cantidad').max = stock;
        
        // Habilitar botón
        document.getElementById('btnRegistrar').disabled = false;
        
        // Resaltar fila seleccionada
        document.querySelectorAll('.producto-row').forEach(row => row.classList.remove('table-active'));
        document.getElementById('producto-row-' + id).classList.add('table-active');
        
        // Calcular monto automáticamente
        calcularMonto();
    }

    function calcularMonto() {
        const cantidad = parseInt(document.getElementById('cantidad').value) || 0;
        const total = cantidad * productoData.precio;
        document.getElementById('monto_calculado').value = total.toFixed(2);
    }

    function toggleMontoCustom() {
        const checked = document.getElementById('usar_monto_custom').checked;
        const container = document.getElementById('monto_custom_container');
        const montoCalculado = document.getElementById('monto_calculado');
        const montoPersonalizado = document.getElementById('monto_personalizado');
        
        if (checked) {
            container.style.display = 'block';
            montoCalculado.readOnly = true;
            montoPersonalizado.required = true;
            montoPersonalizado.value = montoCalculado.value;
        } else {
            container.style.display = 'none';
            montoCalculado.readOnly = true;
            montoPersonalizado.required = false;
        }
    }

    // Validación antes de enviar
    document.getElementById('formVenta').addEventListener('submit', function(e) {
        const cantidad = parseInt(document.getElementById('cantidad').value);
        
        if (!productoData.id) {
            e.preventDefault();
            alert('Debe seleccionar un producto.');
            return false;
        }
        
        if (cantidad > productoData.stock) {
            e.preventDefault();
            alert(`La cantidad no puede exceder el stock disponible (${productoData.stock} unidades).`);
            return false;
        }
    });
</script>

<style>
    .table-active {
        background-color: #d1ecf1 !important;
    }
    
    .sticky-top {
        position: sticky;
        top: 0;
        z-index: 10;
    }
</style>
{% endblock %}
